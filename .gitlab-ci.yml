stages:
  - deploy_staging
  - deploy_production
before_script:
  - apt-get update -qq
  - apt-get install -qq git
  # Setup SSH deploy keys
  - 'which ssh-agent || ( apt-get install -qq openssh-client )'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$SSH_PRIVATE_KEY" | base64 --decode)
  - mkdir -p ~/.ssh
  - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
  - echo "$SSH_PRIVATE_KEY"

deploy_staging:
  type: deploy
  environment:
    name: staging
    url: theshoppingsite.com
  script:
    - ssh -v ubuntu@ec2-18-188-246-187.us-east-2.compute.amazonaws.com "cd /var/www/html/staging && \
    if [ $(ls -A .) ]; \
      then \
       git pull; \
       git checkout staging; \
      else  \
       git clone git@gitlab.com:theshopingsite/shopergy_latest.git; \
       git checkout staging;\
       cp ../.env .;\
       fi; \
    exit"
  only:
    - staging

deploy_production:
  type: deploy
  environment:
    name: production
    url: theshoppingsite.com
  script:
    - ssh -v ubuntu@ec2-18-188-246-187.us-east-2.compute.amazonaws.com "echo production;\
    exit"
  only:
    - master